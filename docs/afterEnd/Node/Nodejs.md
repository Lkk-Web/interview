---
group:
  # title: 'åç«¯'
  order: 3
order: 1
---

# Nodejs

å®˜æ–¹æ–‡æ¡£ï¼š[Node](https://nodejs.org/en/docs/)

## ç®€ä»‹

æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

GraphQL

esql

RPC

é«˜å¹¶å‘

redis

## 1ã€CommonJS è§„èŒƒ

> ç° ES6 çš„ Module åŸºæœ¬å–ä»£äº† CommonJS è§„èŒƒå’Œ AMD è§„èŒƒ

Node åº”ç”¨ç”±æ¨¡å—ç»„æˆï¼Œé‡‡ç”¨ CommonJS æ¨¡å—è§„èŒƒã€‚

CommonJS è§„èŒƒè§„å®šï¼Œæ¯ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œæœ‰è‡ªå·±çš„ä½œç”¨åŸŸã€‚æ¯ä¸ªæ¨¡å—å†…éƒ¨ï¼Œmodule å˜é‡ä»£è¡¨å½“å‰æ¨¡å—ã€‚è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ exports å±æ€§ï¼ˆå³ module.exportsï¼‰æ˜¯å¯¹å¤–çš„æ¥å£ã€‚åŠ è½½æŸä¸ªæ¨¡å—ï¼Œå…¶å®æ˜¯åŠ è½½è¯¥æ¨¡å—çš„ module.exports å±æ€§ã€‚

å¦‚æœæƒ³åœ¨å¤šä¸ªæ–‡ä»¶åˆ†äº«å˜é‡ï¼Œå¿…é¡»å®šä¹‰ä¸º global å¯¹è±¡çš„å±æ€§ã€‚

CommonJS æ¨¡å—çš„ç‰¹ç‚¹å¦‚ä¸‹ã€‚

- æ‰€æœ‰ä»£ç éƒ½è¿è¡Œåœ¨æ¨¡å—ä½œç”¨åŸŸï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸã€‚

- æ¨¡å—å¯ä»¥å¤šæ¬¡åŠ è½½ï¼Œä½†æ˜¯åªä¼šåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶è¿è¡Œä¸€æ¬¡ï¼Œç„¶åè¿è¡Œç»“æœå°±è¢«ç¼“å­˜äº†ï¼Œä»¥åå†åŠ è½½ï¼Œå°±ç›´æ¥è¯»å–ç¼“å­˜ç»“æœã€‚è¦æƒ³è®©æ¨¡å—å†æ¬¡è¿è¡Œï¼Œå¿…é¡»æ¸…é™¤ç¼“å­˜ã€‚

- æ¨¡å—åŠ è½½çš„é¡ºåºï¼ŒæŒ‰ç…§å…¶åœ¨ä»£ç ä¸­å‡ºç°çš„é¡ºåºã€‚

- CommonJS è§„èŒƒåŠ è½½æ¨¡å—æ˜¯åŒæ­¥çš„,AMD è§„èŒƒæ˜¯å¼‚æ­¥çš„ï¼Œç”±äº Node.js ä¸»è¦ç”¨äºæœåŠ¡å™¨ç¼–ç¨‹ï¼Œæ¨¡å—æ–‡ä»¶ä¸€èˆ¬éƒ½å·²ç»å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ï¼Œæ‰€ä»¥åŠ è½½èµ·æ¥æ¯”è¾ƒå¿«ï¼Œä¸ç”¨è€ƒè™‘éåŒæ­¥åŠ è½½çš„æ–¹å¼ï¼Œæ‰€ä»¥ CommonJS è§„èŒƒæ¯”è¾ƒé€‚ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œè¦ä»æœåŠ¡å™¨ç«¯åŠ è½½æ¨¡å—ï¼Œè¿™æ—¶å°±å¿…é¡»é‡‡ç”¨éåŒæ­¥æ¨¡å¼ï¼Œå› æ­¤`æµè§ˆå™¨ç«¯ä¸€èˆ¬é‡‡ç”¨ AMD è§„èŒƒ`ã€‚

### 1.1ã€exports è§„èŒƒ

module.exports å±æ€§è¡¨ç¤ºå½“å‰æ¨¡å—å¯¹å¤–è¾“å‡ºçš„æ¥å£ï¼Œå…¶ä»–æ–‡ä»¶åŠ è½½è¯¥æ¨¡å—ï¼Œå®é™…ä¸Šå°±æ˜¯è¯»å– module.exports å˜é‡ã€‚

```javascript
module.exports = 'Hello world';
```

`exports`å’Œ`module.export` éƒ½æ˜¯æ„å‘³ç€æ˜¯ä¸ªæ¨¡å—çš„å¯¹å¤–æ¥å£ï¼Œå› æ­¤å°½é‡é¿å…é‡æ–°èµ‹å€¼

### 1.2ã€require è§„èŒƒ

require å‘½ä»¤ç”¨äºåŠ è½½æ–‡ä»¶ï¼Œåç¼€åé»˜è®¤ä¸º.js

```javascript
// requireæ–¹æ³•ç”¨äºåŠ è½½æ¨¡å—ã€‚
var example = require('./example.js');
```

> å¦‚æœå‚æ•°å­—ç¬¦ä¸²ä¸ä»¥â€œ./â€œæˆ–â€/â€œå¼€å¤´ï¼Œåˆ™è¡¨ç¤ºåŠ è½½çš„æ˜¯ä¸€ä¸ªé»˜è®¤æä¾›çš„æ ¸å¿ƒæ¨¡å—ï¼ˆä½äº Node çš„ç³»ç»Ÿå®‰è£…ç›®å½•ä¸­ï¼‰ï¼Œæˆ–è€…ä¸€ä¸ªä½äºå„çº§ node_modules ç›®å½•çš„å·²å®‰è£…æ¨¡å—ï¼ˆå…¨å±€å®‰è£…æˆ–å±€éƒ¨å®‰è£…ï¼‰ã€‚

- å¦‚æœæƒ³å¾—åˆ° require å‘½ä»¤åŠ è½½çš„ç¡®åˆ‡æ–‡ä»¶åï¼Œä½¿ç”¨ `require.resolve()`æ–¹æ³•ã€‚

#### 1.2.1ã€require.main

require æ–¹æ³•æœ‰ä¸€ä¸ª main å±æ€§ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ¨¡å—æ˜¯ç›´æ¥æ‰§è¡Œï¼Œè¿˜æ˜¯è¢«è°ƒç”¨æ‰§è¡Œã€‚

ç›´æ¥æ‰§è¡Œçš„æ—¶å€™ï¼ˆnode module.jsï¼‰ï¼Œrequire.main å±æ€§æŒ‡å‘æ¨¡å—æœ¬èº«ã€‚

```javascript
require.main === module;
```

è°ƒç”¨æ‰§è¡Œçš„æ—¶å€™ï¼ˆé€šè¿‡ require åŠ è½½è¯¥è„šæœ¬æ‰§è¡Œï¼‰ï¼Œä¸Šé¢çš„è¡¨è¾¾å¼è¿”å› false

### 1.3ã€æ¨¡å—åŠ è½½æœºåˆ¶

CommonJS æ¨¡å—çš„åŠ è½½æœºåˆ¶æ˜¯ï¼Œè¾“å‡ºçš„å€¼æ˜¯è¢«è¾“å‡ºçš„å€¼çš„æ‹·è´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦è¾“å‡ºä¸€ä¸ªå€¼ï¼Œæ¨¡å—å†…éƒ¨çš„å˜åŒ–å°±å½±å“ä¸åˆ°è¿™ä¸ªå€¼ã€‚ã€‚

### 1.4ã€æ¨¡å—ç¼“å­˜æœºåˆ¶

ç¬¬ä¸€æ¬¡åŠ è½½æŸä¸ªæ¨¡å—æ—¶ï¼ŒNode ä¼šç¼“å­˜è¯¥æ¨¡å—ã€‚ä»¥åå†åŠ è½½è¯¥æ¨¡å—ï¼Œå°±ç›´æ¥ä»ç¼“å­˜å–å‡ºè¯¥æ¨¡å—çš„ module.exports å±æ€§ã€‚

```javascript
require('./example.js');
require('./example.js').message = 'hello';
require('./example.js').message;
// "hello"
```

ä¸Šé¢ä»£ç ä¸­ï¼Œè¿ç»­ä¸‰æ¬¡ä½¿ç”¨ require å‘½ä»¤ï¼ŒåŠ è½½åŒä¸€ä¸ªæ¨¡å—ã€‚ç¬¬äºŒæ¬¡åŠ è½½çš„æ—¶å€™ï¼Œä¸ºè¾“å‡ºçš„å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ª message å±æ€§ã€‚ä½†æ˜¯ç¬¬ä¸‰æ¬¡åŠ è½½çš„æ—¶å€™ï¼Œè¿™ä¸ª message å±æ€§ä¾ç„¶å­˜åœ¨ï¼Œè¿™å°±è¯æ˜ require å‘½ä»¤å¹¶æ²¡æœ‰é‡æ–°åŠ è½½æ¨¡å—æ–‡ä»¶ï¼Œè€Œæ˜¯è¾“å‡ºäº†ç¼“å­˜ã€‚

å¦‚æœæƒ³è¦å¤šæ¬¡æ‰§è¡ŒæŸä¸ªæ¨¡å—ï¼Œå¯ä»¥è®©è¯¥æ¨¡å—è¾“å‡ºä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæ¯æ¬¡ require è¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œä¸€ä¸‹è¾“å‡ºçš„å‡½æ•°ã€‚

æ‰€æœ‰ç¼“å­˜çš„æ¨¡å—ä¿å­˜åœ¨ require.cache ä¹‹ä¸­ï¼Œå¦‚æœæƒ³åˆ é™¤æ¨¡å—çš„ç¼“å­˜ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ã€‚

```javascript
// åˆ é™¤æŒ‡å®šæ¨¡å—çš„ç¼“å­˜
delete require.cache[moduleName];

// åˆ é™¤æ‰€æœ‰æ¨¡å—çš„ç¼“å­˜
Object.keys(require.cache).forEach(function (key) {
  delete require.cache[key];
});
```

æ³¨æ„ï¼Œç¼“å­˜æ˜¯æ ¹æ®ç»å¯¹è·¯å¾„è¯†åˆ«æ¨¡å—çš„ï¼Œå¦‚æœåŒæ ·çš„æ¨¡å—åï¼Œä½†æ˜¯ä¿å­˜åœ¨ä¸åŒçš„è·¯å¾„ï¼Œrequire å‘½ä»¤è¿˜æ˜¯ä¼šé‡æ–°åŠ è½½è¯¥æ¨¡å—ã€‚

### 1.5 CMD è§„èŒƒ

CMDï¼ˆCommon Module Definitionï¼‰æ˜¯å›½å†…å¤§ç‰›ç‰ä¼¯åœ¨å¼€å‘ SeaJS çš„æ—¶å€™æå‡ºæ¥çš„ï¼Œ`å±äº CommonJS çš„ä¸€ç§è§„èŒƒ`ï¼Œæ ¹æ®æµè§ˆå™¨çš„å¼‚æ­¥ç¯å¢ƒåšäº†è‡ªå·±çš„å®ç°ã€‚å®ƒå’Œ AMD å¾ˆç›¸ä¼¼ï¼Œå°½é‡ä¿æŒç®€å•ï¼Œå¹¶ä¸ CommonJS å’Œ Node.js çš„ Modules è§„èŒƒä¿æŒäº†å¾ˆå¤§çš„å…¼å®¹æ€§ã€‚

### 1.5.1 define æ–¹æ³•ï¼šå®šä¹‰æ¨¡å—

åœ¨ CMD ä¸­ï¼Œä¸€ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ ¼å¼ä¸ºï¼šdefine( factory )ï¼›define æ˜¯ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç”¨æ¥å®šä¹‰æ¨¡å—ã€‚

defin.cmd å±æ€§æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå¯ç”¨æ¥åˆ¤å®šå½“å‰é¡µé¢æ˜¯å¦æœ‰ CMD æ¨¡å—åŠ è½½å™¨ï¼Œå…¶ç”¨æ³•è·Ÿ AMD çš„ denfine.amd ç›¸ä¼¼ï¼Œå†™æ³•å¦‚ä¸‹ï¼š

```js
if (typeof define === 'function' && define.cmd) {
  // æœ‰ Sea.js ç­‰ CMD æ¨¡å—åŠ è½½å™¨å­˜åœ¨
}
```

## 2ã€æ´‹è‘±åœˆæ¨¡å‹

åœ¨ `koa` ä¸­ï¼Œä¸­é—´ä»¶è¢« `next()` æ–¹æ³•åˆ†æˆäº†ä¸¤éƒ¨åˆ†ã€‚`next()` æ–¹æ³•ä¸Šé¢éƒ¨åˆ†ä¼šå…ˆæ‰§è¡Œï¼Œä¸‹é¢éƒ¨é—¨ä¼šåœ¨åç»­ä¸­é—´ä»¶æ‰§è¡Œå…¨éƒ¨ç»“æŸä¹‹åå†æ‰§è¡Œã€‚

æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªè¯·æ±‚æˆ–è€…æ“ä½œ `db` çš„è€—æ—¶æ˜¯å¤šå°‘ï¼Œè€Œä¸”æƒ³è·å–å…¶ä»–ä¸­é—´ä»¶çš„ä¿¡æ¯ã€‚åœ¨ `koa` ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `async await` çš„æ–¹å¼ç»“åˆæ´‹è‘±æ¨¡å‹åšåˆ°ã€‚

```javascript
app.use(async (ctx, next) => {
  const start = new Date();
  await next();
  const delta = new Date() - start;
  console.log(`è¯·æ±‚è€—æ—¶: ${delta} MS`);
  console.log('æ‹¿åˆ°ä¸Šä¸€æ¬¡è¯·æ±‚çš„ç»“æœï¼š', ctx.state.baiduHTML);
});

app.use(async (ctx, next) => {
  // å¤„ç† db æˆ–è€…è¿›è¡Œ HTTP è¯·æ±‚
  ctx.state.baiduHTML = await axios.get('http://baidu.com');
});
```

## 3ã€Node EventLoop

NodeJS ä¸­çš„ EventLoop ä½¿ NodeJS èƒ½å¤Ÿè¿›è¡Œéé˜»å¡çš„ I/O æ“ä½œï¼Œå°½ç®¡ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œå¯ä»¥é€šè¿‡å°† I/O æ“ä½œäº¤ç»™ç³»ç»Ÿå†…æ ¸å»æ‰§è¡Œã€‚

å½“æŸä¸ª I/O æ“ä½œç»“æŸçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šå°†å¯¹åº”çš„ callback å‡½æ•°å…ƒä¿¡æ¯äº¤ç»™ NodeJS ä¸­çš„ poll queue(è½®è¯¢é˜Ÿåˆ—)ã€‚

å½“æˆ‘ä»¬çš„è„šæœ¬ä¸­è°ƒç”¨äº†`å¼‚æ­¥å‡½æ•°`ï¼Œè®¡æ—¶å™¨æˆ–è€… process.nextTick()çš„æ—¶å€™ï¼ŒEventLoop æœºåˆ¶å°±ä¼šå¼€å§‹ä»‹å…¥ã€‚

ä¸‹å›¾ç®€æ˜åœ°å±•ç¤ºäº† EventLoop çš„æ“ä½œé¡ºåºï¼š

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `timersï¼ˆè®¡æ—¶é˜¶æ®µï¼‰`ï¼šè¿™ä¸ªé˜¶æ®µæ‰§è¡Œç”± setTimeout() å’Œ setInterval() è°ƒåº¦çš„å›è°ƒã€‚

  Â· NodeJS.Timeout æ˜¯ Node.js å®šä¹‰çš„ç±»å‹ï¼Œè¡¨ç¤ºå®šæ—¶å™¨å¯¹è±¡ã€‚

  ```ts
      // å¯åŠ¨ä¸€ä¸ª 30 ç§’çš„å®šæ—¶å™¨, è¸¢å‡ºæœªå‡†å¤‡çš„ç©å®¶
      const removeTimer = setTimeout(() => { this.leave(undefined, deskInfo) }, 30000)
      DeskClubService.timers.set(deskID, removeTimer)
      // å®šæ—¶å™¨è¿”å›å€¼ä¸ºidï¼Œnodeç¯å¢ƒä¸º NodeJS.Timeout ç±»å‹
      const removeTimer = DeskClubService.timers.get(deskID)
      removeTimer && clearTimeout(removeTimer)
      static timers: Map<string, NodeJS.Timeout> = new Map();  // æ‰€æœ‰æˆ¿é—´
  ```

- `pending callbacksï¼ˆå›è°ƒå¾…å¤„ç†é˜¶æ®µï¼‰`ï¼šè¿™ä¸ªé˜¶æ®µæ‰§è¡Œå»¶è¿Ÿåˆ°ä¸‹ä¸€æ¬¡å¾ªç¯è¿­ä»£çš„ I/O å›è°ƒã€‚
- `idle, prepareï¼ˆé—²ç½®é˜¶æ®µï¼‰`ï¼šä»…ä»…è¢« NodeJS å†…éƒ¨ä½¿ç”¨ã€‚ï¼ˆè¿™é‡Œæ˜¯æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°çš„ï¼Œä¸èƒ½ç”šè§£ï¼‰
- `pollï¼ˆè½®è¯¢é˜¶æ®µï¼‰`ï¼šè¿™ä¸ªé˜¶æ®µæ£€ç´¢ I/O äº‹ä»¶ï¼Œæ‰§è¡Œ I/O äº‹ä»¶å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼ˆé™¤äº†å…³é—­å›è°ƒã€è®¡æ—¶å™¨è°ƒåº¦çš„å›è°ƒå’Œ setImmediate() ä¹‹å¤–çš„å‡ ä¹æ‰€æœ‰å¼‚æ­¥æ“ä½œï¼‰ï¼Œéƒ½å°†ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè¢«å¤„ç†ã€‚
- `checkï¼ˆæ£€æµ‹é˜¶æ®µï¼‰`ï¼šsetImmediate()å‡½æ•°çš„å›è°ƒå‡½æ•°å°†ä¼šåœ¨è¿™é‡Œè¢«å¤„ç†ã€‚
- `close callbacksï¼ˆå…³é—­å›è°ƒé˜¶æ®µï¼‰`ï¼šä¾‹å¦‚ï¼šsocket.on('close', ...)

## 4ã€cnpmã€npm ã€pnpmã€yarn

Node.js æ˜¯ JavaScript çš„**è¿è¡Œæ—¶ç¯å¢ƒ**ï¼Œnpm æ˜¯ Node.js **å†…ç½®çš„åŒ…ç®¡ç†å™¨**ï¼Œcnpm å’Œ pnpm æ˜¯ npm çš„æ›¿ä»£ / å¢å¼ºå·¥å…·ï¼Œä¸‰è€…éƒ½ä¾èµ– Node.js æ‰èƒ½è¿è¡Œï¼Œnvm åˆ™æ˜¯ç”¨æ¥ç®¡ç† Node.js ç‰ˆæœ¬çš„å·¥å…·ã€‚

### 4.1 npm (Node Package Manager)

todo å¦‚ä½•åšå…¬å¸å†…éƒ¨åŒ…ç®¡ç†æ–¹æ¡ˆ

npm æ˜¯ Node.js å®˜æ–¹å†…ç½® çš„åŒ…ç®¡ç†å™¨ï¼Œæ˜¯ Node.js ç”Ÿæ€çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œåªè¦ä½ å®‰è£…äº† Node.jsï¼Œé»˜è®¤å°±ä¼šè‡ªå¸¦ npm

- å®‰è£…åŒ…æ—¶é»˜è®¤é‡‡ç”¨åµŒå¥—ä¾èµ–ï¼ˆæ¯ä¸ªåŒ…çš„ä¾èµ–éƒ½æ”¾åœ¨è‡ªå·±çš„ node_modules ä¸‹ï¼‰ï¼Œå¯¼è‡´ node_modules ä½“ç§¯åºå¤§ã€åµŒå¥—å±‚çº§æ·±ï¼›

- å­˜åœ¨ä¾èµ–å¹½çµï¼ˆæœªå£°æ˜çš„åŒ…ä¹Ÿèƒ½è¢«å¼•ç”¨ï¼‰ã€ä¾èµ–åˆ†èº«ï¼ˆåŒä¸€ä¸ªåŒ…å¯èƒ½è¢«å¤šæ¬¡å®‰è£…ï¼‰ç­‰é—®é¢˜

#### 4.1 ä¾èµ–å†²çª

**ä¾èµ–å†²çª â‰  å®‰è£…æŠ¥é”™**

çœŸæ­£çš„ä¾èµ–å†²çªåŒ…æ‹¬ 3 ç±»ï¼š

1. ç‰ˆæœ¬å†²çªï¼ˆæœ€å¸¸è§ï¼‰


```sh
Could not resolve dependency:
foo@^2.0.0
bar requires foo@^1.0.0
```

2. peerDependencies å†²çªï¼ˆnpm v7+ é‡ç¾åŒºï¼‰
    - æŸ¥çœ‹ peer è¦æ±‚
    - å‡çº§å®¿ä¸»åŒ…
    - æˆ–æ¢æ’ä»¶ç‰ˆæœ¬
```sh
ERESOLVE unable to resolve dependency tree
peer react@"^18" from xxx
```

3. è¿è¡ŒæœŸå†²çªï¼ˆèƒ½è£…ï¼Œä½†è·‘ä¸èµ·æ¥ï¼‰

```sh
TypeError: xxx is not a function
```

#### 4.2 ç§æœ‰åŒ…

å‘å¸ƒ `ç§æœ‰ npm åŒ…`ï¼ˆPrivate Packageï¼‰å…¶å®å’Œå‘å¸ƒå…¬å¼€åŒ…ç±»ä¼¼ï¼Œä½†æ¶‰åŠæƒé™ã€è®¿é—®æ§åˆ¶å’Œ Registry é…ç½®

- npm ç§æœ‰åŒ…å‘å¸ƒæµç¨‹

1. è®¾ç½® npm è´¦å·

```sh
npm login

è¾“å…¥ï¼šUsernameã€Passwordã€Email
```
æˆåŠŸåï¼Œnpm ä¼šåœ¨ ~/.npmrc ä¿å­˜ token

2. åˆå§‹åŒ– package.json

```
mkdir my-private-lib
cd my-private-lib
npm init -y
```

- ä¿®æ”¹ package.jsonï¼š

```json
{
  "name": "@my-org/my-private-lib", // @casstime/copilot
  "version": "1.0.0",
  "private": false,       // âŒ æ³¨æ„ä¸èƒ½è®¾ç½® trueï¼Œå¦åˆ™ä¸èƒ½ publish
  "publishConfig": {
    "access": "restricted"
  }
}

// @my-org â†’ å‘½åç©ºé—´ï¼Œå»ºè®®ç»„ç»‡å
// publishConfig.access = "restricted" â†’ å‘å¸ƒç§æœ‰åŒ…
// private: true â†’ ä»…ç¦æ­¢å‘å¸ƒï¼Œéå¿…å¡«
```

3. å‘å¸ƒåŒ…

```sh
npm publish
```

å‘å¸ƒååŒ…é»˜è®¤ç§æœ‰ï¼Œå…¶ä»–å›¢é˜Ÿæˆå‘˜å¯ä»¥ï¼š`npm install @my-org/my-private-lib`ã€‚å‰ææ˜¯ï¼šå·² npm loginï¼Œæ‹¥æœ‰ç»„ç»‡è®¿é—®æƒé™

#### 4.3 è‡ªå»º npm Registry

è‡ªå»º Registry èƒ½è§£å†³ä»€ä¹ˆï¼Ÿ

âœ… å†…ç½‘è®¿é—®

âœ… ç§æœ‰åŒ…ä¸å‡ºå…¬å¸

âœ… å…¬å…±åŒ…ç¼“å­˜ï¼ˆåŠ é€Ÿå®‰è£…ï¼‰

âœ… å®Œå…¨æ§åˆ¶æƒé™ & ç‰ˆæœ¬

âœ… å¯æ¥å…¥ CI/CD

|æ–¹æ¡ˆ	|	é€‚åˆè°|	ç‰¹ç‚¹|
| ---- | ---------- | ------------------------------------ |
| Verdaccio	|	ä¸­å°å›¢é˜Ÿ|	è½»é‡ã€npm åŸç”Ÿã€ä¸Šæ‰‹å¿«|
| Nexus Repository	| æŠ€æœ¯å›¢é˜Ÿ	|	ä¼ä¸š	å¤šä»“åº“ç±»å‹ã€æƒé™å¤æ‚|
| Artifactory | å¤§å‚	|	å•†ä¸šåŒ–ã€å…¨åˆ¶å“ç®¡ç† |

- â­ï¸ Verdaccioï¼ˆå¤Ÿç”¨ï¼‰

1. å®‰è£…

```sh
npm install -g verdaccio
verdaccio
```

ç«¯å£ï¼š4873

åœ°å€ï¼šhttp://localhost:4873

è®¿é—®æµè§ˆå™¨å³å¯çœ‹åˆ° Registry UIã€‚

2. npm æŒ‡å‘ç§æœ‰ Registry

åœ¨é¡¹ç›®æ ¹ç›®å½• `.npmrc`

```env
registry=http://localhost:4873
# æˆ–è€… scoped
@my-org:registry=http://localhost:4873
```
ğŸ‘‰ å…¬å…±åŒ…ä»èµ°å®˜æ–¹ï¼Œç§æœ‰åŒ…èµ°è‡ªå»º

3. åˆ›å»ºç”¨æˆ· & ç™»å½• & å‘å¸ƒ

```sh
# åˆ›å»ºç”¨æˆ·
npm adduser --registry http://localhost:4873
# å‘å¸ƒ
npm publish --registry http://localhost:4873
# å®‰è£…
npm install @my-org/utils
```

4. Verdaccio å·¥ä½œåŸç†
```
npm install
   â†“
Verdaccio Registry
   â†“
â”œâ”€ ç§æœ‰åŒ… â†’ æœ¬åœ° storage
â””â”€ å…¬å…±åŒ… â†’ ä»£ç† npmjs.orgï¼ˆç¼“å­˜ï¼‰
```

5. æƒé™ & å®‰å…¨ï¼ˆç”Ÿäº§é…ç½®ï¼‰

- Verdaccio é…ç½®æ–‡ä»¶

```sh
verdaccio --config ./config.yaml 
verdaccio --config ~/.config/verdaccio/config.yaml  # macos
```

å…³é”®é…ç½®ï¼ˆç®€åŒ–ï¼‰ï¼š

```yaml
auth:
  htpasswd:
    file: ./htpasswd

packages:
  '@my-org/*':
    access: $authenticated
    publish: $authenticated

  '**':
    access: $all # authenticated åˆ™è¦é‰´æƒ
    publish: $authenticated
```
`@my-org/*` â†’ åªæœ‰ç™»å½•ç”¨æˆ·å¯è®¿é—® & å‘å¸ƒ

å…¬å…±åŒ…ä»»ä½•äººå¯ installï¼Œä½†ä¸èƒ½ publish

6. å¸¸è§é—®é¢˜

âŒ package.json å†™äº† "private": true â†’ æ°¸è¿œä¸èƒ½ publish

âŒ æ²¡åšå¤‡ä»½ â†’ Registry æŒ‚äº† = å…¨å…¬å¸ä¾èµ–æŒ‚

âŒ registry å…¨å±€æ›¿æ¢ â†’ npm install æ…¢ / 404 âœ… ç”¨ scoped registry

#### 4.4 ç‰ˆæœ¬æ²»ç†

- SemVer 

è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemVerï¼‰æ ¼å¼ï¼š `MAJOR.MINOR.PATCH`

1. PATCHï¼ˆè¡¥ä¸ç‰ˆæœ¬ï¼‰

> åªä¿® bugï¼Œä¸æ”¹å˜å¯¹å¤–è¡Œä¸º

ä¿®å¤ bug

æ€§èƒ½ä¼˜åŒ–

å®‰å…¨ä¿®å¤

ä¸æ”¹ API

ä¸å½±å“å·²æœ‰ç”¨æ³•

2. MINORï¼ˆå°ç‰ˆæœ¬ï¼‰

> å‘åå…¼å®¹åœ°å¢åŠ åŠŸèƒ½

æ–°å¢ API

æ–°å¢åŠŸèƒ½

ä¿æŒæ—§ API å¯ç”¨

3. MAJORï¼ˆä¸»ç‰ˆæœ¬

> ç ´åæ€§æ›´æ–°

åˆ é™¤æˆ–é‡æ„ API

è¡Œä¸ºæ”¹å˜

ä¸ä¿è¯å…¼å®¹

| å†™æ³•       | å«ä¹‰               | å»ºè®®     |
| -------- | ---------------- | ------ |
| `^1.2.3` | å…è®¸ minor / patch | âš ï¸ è°¨æ…  |
| `~1.2.3` | åªå…è®¸ patch        | âœ… æ¨è   |
| `1.2.3`  | ç²¾ç¡®ç‰ˆæœ¬             | âœ… æ ¸å¿ƒä¾èµ– |
| `*`      | ä»»æ„               | âŒ ç¦æ­¢   |
| `>=`     | ä¸‹é™               | âŒ ç¦æ­¢   |

å‡çº§æµç¨‹
```
åˆ›å»ºå‡çº§åˆ†æ”¯
   â†“
å‡çº§æŒ‡å®šä¾èµ–
   â†“
æ›´æ–° lock
   â†“
è·‘æµ‹è¯• / æ„å»º
   â†“
è¯„å®¡
   â†“
åˆå¹¶
```

### 4.2 cnpm (China NPM)

cnpm æ˜¯æ·˜å®å›¢é˜Ÿä¸ºè§£å†³ npm å›½å†…è®¿é—®æ…¢çš„é—®é¢˜å¼€å‘çš„npm å›½å†…é•œåƒç‰ˆï¼Œæœ¬è´¨æ˜¯ npm çš„ â€œå›½å†…é€‚é…ç‰ˆâ€ã€‚ä¸éš Node.js å†…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œä¸”è¿è¡Œä»ä¾èµ– Node.js ç¯å¢ƒã€‚

åŠŸèƒ½å’Œ npm å®Œå…¨ä¸€è‡´ï¼Œå”¯ä¸€æ ¸å¿ƒå·®å¼‚æ˜¯é»˜è®¤ä¸‹è½½æºæ˜¯æ·˜å® npm é•œåƒï¼ˆregistry.npmmirror.comï¼‰ï¼Œå›½å†…ä¸‹è½½é€Ÿåº¦æå¿«ï¼›
æ—©æœŸç‰ˆæœ¬æ›¾é‡‡ç”¨å…¨å±€æ‰å¹³å®‰è£…ï¼Œåæ¥é€æ­¥å’Œ npm å¯¹é½ã€‚

å…¼å®¹æ€§ï¼šéƒ¨åˆ†åœºæ™¯ä¸‹ï¼ˆå¦‚ä¾èµ–è·¯å¾„ä¸¥æ ¼çš„åŒ…ï¼‰ï¼Œcnpm å¯èƒ½å‡ºç°å…¼å®¹é—®é¢˜ï¼Œä¸å¦‚ npm åŸç”Ÿç¨³å®šã€‚

- åŸºæœ¬ä½¿ç”¨å‘½ä»¤ï¼š

```sh
npm install -g cnpm       # å…¨å±€å®‰è£… cnpm
cnpm install åŒ…å          # å®‰è£…åŒ…ï¼ˆç”¨æ³•å’Œ npm å‡ ä¹ä¸€è‡´ï¼‰
```

### 4.3 pnpm (Performant NPM)

pnpm æ˜¯æ–°ä¸€ä»£é«˜æ€§èƒ½åŒ…ç®¡ç†å™¨ï¼Œä¸»æ‰“ â€œé«˜æ•ˆã€èŠ‚çœç£ç›˜ç©ºé—´â€ï¼Œæ˜¯ npm çš„å¢å¼ºæ›¿ä»£å·¥å…·ã€‚åŒæ ·ä¸éš Node.js å†…ç½®ï¼Œéœ€æ‰‹åŠ¨å®‰è£…ï¼Œä¾èµ– Node.js è¿è¡Œ

- æ ¸å¿ƒå·®å¼‚ï¼ˆå¯¹æ¯” npm/cnpmï¼‰ï¼š

1. ç£ç›˜ç©ºé—´èŠ‚çœï¼šé‡‡ç”¨å†…å®¹å¯»å€å­˜å‚¨ï¼ˆCASï¼‰ï¼ŒåŒä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬ä»…å­˜å‚¨å·®å¼‚éƒ¨åˆ†ï¼Œå…¨å±€å…±äº«ç¼“å­˜ï¼Œå®‰è£…å¤šä¸ªé¡¹ç›®æ—¶é‡å¤åŒ…åªå­˜ä¸€ä»½ï¼›

2. å®‰è£…é€Ÿåº¦å¿«ï¼šæ¯” npm å¿« 2-3 å€ï¼Œæ¯” yarn ä¹Ÿå¿«ï¼Œå› ä¸ºå¤ç”¨ç¼“å­˜ä¸”é¿å…é‡å¤ä¸‹è½½

3. ä¾èµ–ç»“æ„æ¸…æ™°ï¼šé‡‡ç”¨ç¬¦å·é“¾æ¥ + è™šæ‹Ÿå­˜å‚¨ï¼Œnode_modules æ˜¯æ‰å¹³ç»“æ„ä½†æ— ä¾èµ–åˆ†èº«ï¼Œè§£å†³äº† npm çš„ â€œä¾èµ–å¹½çµâ€ é—®é¢˜ï¼›
    - pnpm ä¸ä¼šæŠŠåŒ…æ–‡ä»¶å¤åˆ¶åˆ°é¡¹ç›®çš„ node_modulesï¼Œè€Œæ˜¯åˆ›å»ºç¡¬é“¾æ¥ï¼ˆæŒ‡å‘å…¨å±€ç¼“å­˜çš„æ–‡ä»¶ï¼‰å’Œç¬¦å·é“¾æ¥ï¼ˆæŒ‡å‘ç¡¬é“¾æ¥ï¼‰ï¼š
    - ç¡¬é“¾æ¥ï¼šè®©å¤šä¸ªæ–‡ä»¶è·¯å¾„æŒ‡å‘åŒä¸€ä¸ªç‰©ç†æ–‡ä»¶ï¼ˆç£ç›˜ä¸Šä»…å­˜ä¸€ä»½ï¼‰ï¼›
    - ç¬¦å·é“¾æ¥ï¼šç›¸å½“äº â€œå¿«æ·æ–¹å¼â€ï¼ŒæŒ‡å‘ç¡¬é“¾æ¥çš„ä½ç½®ã€‚ 

4. å…¼å®¹æ€§å¥½ï¼šå®Œå…¨å…¼å®¹ npm çš„ package.json å’Œ lock æ–‡ä»¶ï¼ˆpackage-lock.jsonï¼‰

### 4.4 yarn (Node Version Manager)

æ—©æœŸ npmï¼ˆv3 ä¹‹å‰ï¼‰çš„é—®é¢˜ï¼š

- å®‰è£…æ…¢ï¼ˆä¸²è¡Œï¼‰

- ä¾èµ–æ ‘ä¸ç¨³å®š

- æ²¡æœ‰å¼ºä¸€è‡´æ€§ lock æœºåˆ¶

- CI ç»å¸¸ â€œæˆ‘æœ¬åœ°èƒ½è·‘ï¼ŒæœåŠ¡å™¨ä¸è¡Œâ€

Facebook / Google / Exponentï¼ˆRNï¼‰ å—ä¸äº† â†’ Yarn è¯ç”Ÿ

`Yarn çš„æ ¸å¿ƒè®¾è®¡ï¼ˆé‡ç‚¹ï¼‰`

1ï¸âƒ£ yarn.lock â€”â€” Yarn çš„çµé­‚

åŒä¸€ä¸ª package.json,ä¸åŒæ—¶é—´ã€ä¸åŒæœºå™¨,å®‰è£…ç»“æœå¿…é¡»ä¸€æ ·

2ï¸âƒ£ ä¾èµ–è§£æ & Hoisting

> ä»€ä¹ˆæ˜¯ Hoistingï¼Ÿ

**æŠŠå¤šä¸ªåŒ…å…±ç”¨çš„ä¾èµ–ï¼Œæå‡åˆ° node_modules é¡¶å±‚**

```ts
node_modules/
  react
  lodash
  axios

è€Œä¸æ˜¯

a/node_modules/lodash
b/node_modules/lodash
```
Yarn çš„ç‰¹ç‚¹

- æ›´æ¿€è¿› hoist

- å®‰è£…ç»“æœæ›´æ‰å¹³

- è€é¡¹ç›®æ›´å®¹æ˜“è·‘èµ·æ¥

3ï¸âƒ£ å¹¶è¡Œä¸‹è½½ & ç¦»çº¿ç¼“å­˜

ç¼“å­˜æœºåˆ¶ï¼šæ‰€æœ‰ä¸‹è½½è¿‡çš„åŒ…éƒ½ä¼šè¿›å…¨å±€ cache

ä¸‹æ¬¡å®‰è£…ï¼šä¸èµ°ç½‘ç»œã€ç›´æ¥å‘½ä¸­ç¼“å­˜

### 4.5 nvm (Node Version Manager)

nvm æ˜¯ Node.js ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œå’ŒåŒ…ç®¡ç†å™¨ï¼ˆnpm/cnpm/pnpmï¼‰æ˜¯å®Œå…¨ä¸åŒç»´åº¦çš„å·¥å…·ï¼Œæ ¸å¿ƒè§£å†³ Node.js ç‰ˆæœ¬åˆ‡æ¢çš„é—®é¢˜ã€‚
åˆ‡æ¢ Node.js ç‰ˆæœ¬åï¼Œå¯¹åº”çš„å†…ç½® npm ç‰ˆæœ¬ä¹Ÿä¼šè·Ÿç€åˆ‡æ¢ï¼ˆä¸åŒ Node.js ç‰ˆæœ¬å†…ç½®çš„ npm ç‰ˆæœ¬ä¸åŒï¼‰ï¼›

- æ ¸å¿ƒä½œç”¨

1. å¤šç‰ˆæœ¬ Node.js å…±å­˜ï¼šæ¯”å¦‚ä½ çš„ç”µè„‘ä¸ŠåŒæ—¶éœ€è¦ **Node.js 14ï¼ˆé€‚é…æ—§é¡¹ç›®ï¼‰**ã€Node.js 20ï¼ˆé€‚é…æ–°é¡¹ç›®ï¼‰ï¼Œnvm å¯ä»¥å¿«é€Ÿåˆ‡æ¢ï¼Œæ— éœ€å¸è½½é‡è£…ï¼›

2. å¿«é€Ÿå®‰è£… / å¸è½½ç‰ˆæœ¬ï¼šä¸€è¡Œå‘½ä»¤å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Node.jsï¼Œæ— éœ€æ‰‹åŠ¨ä¸‹è½½å®‰è£…åŒ…ã€‚

- å¸¸ç”¨å‘½ä»¤
```sh
nvm list                # æŸ¥çœ‹å·²å®‰è£…çš„ Node.js ç‰ˆæœ¬
nvm install 20.10.0     # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Node.js
nvm use 20.10.0         # åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
nvm alias default 20.10.0 # è®¾ç½®é»˜è®¤ç‰ˆæœ¬
nvm uninstall 14.17.0   # å¸è½½æŒ‡å®šç‰ˆæœ¬
```

3. æ·»åŠ æ’ä»¶ - ç»ˆç«¯è‡ªåŠ¨ nvm use `nvmrc`

vscode æ’ä»¶å¸‚åœº æœç´¢ `vsc-nvm`